<div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6"
     x-data="productManager()">

    <h2 class="text-xl font-bold text-gray-800 mb-6">{{ title }}</h2>

    <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6 text-center">
        <p class="text-xs text-blue-600 mb-1">نام محصول شما در سایت به این صورت نمایش داده می‌شود:</p>
        <h3 class="text-lg font-bold text-gray-800" x-text="generateName() || 'دسته‌بندی و مدل را وارد کنید...'"></h3>
    </div>

    <form method="post" enctype="multipart/form-data" class="space-y-6">
        {% csrf_token %}
        {{ form.media }}

        <input type="hidden" name="specifications" :value="specJSON">

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-1">دسته‌بندی</label>
                <div @change="category = $event.target.options[$event.target.selectedIndex].text">
                    {{ form.category }}
                </div>
            </div>
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-1">برند</label>
                <div @change="brand = $event.target.options[$event.target.selectedIndex].text">
                    {{ form.brand }}
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-1">مدل محصول</label>
                <div @input="model = $event.target.value">
                    {{ form.model_name }}
                </div>
            </div>
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-1">ویژگی کلیدی (در عنوان)</label>
                <div @input="desc = $event.target.value">
                    {{ form.title_desc }}
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-1">قیمت (تومان)</label>
                {{ form.price }}
            </div>
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-1">قیمت با تخفیف</label>
                {{ form.discount_price }}
            </div>
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-1">موجودی انبار</label>
                {{ form.stock }}
            </div>
        </div>

        <div class="border border-gray-200 rounded-xl p-4 bg-gray-50">
            <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                مشخصات فنی
            </h3>

            <template x-for="(spec, index) in specs" :key="index">
                <div class="flex gap-2 mb-2">
                    <input type="text" x-model="spec.key" placeholder="نام ویژگی (مثلا: رنگ)" class="w-1/3 p-2 border rounded-lg text-sm">
                    <input type="text" x-model="spec.value" placeholder="مقدار (مثلا: مشکی)" class="w-2/3 p-2 border rounded-lg text-sm">
                    <button type="button" @click="removeSpec(index)" class="text-red-500 hover:text-red-700 px-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>
            </template>

            <button type="button" @click="addSpec()" class="text-blue-600 text-sm font-bold flex items-center gap-1 mt-2 hover:bg-blue-50 p-2 rounded transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                افزودن سطر جدید
            </button>
        </div>

        <div>
            <label class="block text-sm font-bold text-gray-700 mb-1">توضیحات محصول</label>
            {{ form.description }}
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-1">تصویر اصلی (کاور)</label>
                {{ form.image }}
                {% if form.instance.image %}
                    <img src="{{ form.instance.image.url }}" class="w-20 h-20 object-contain mt-2 border rounded">
                {% endif %}
            </div>

            <div>
                <label class="block text-sm font-bold text-gray-700 mb-1">سایر تصاویر (گالری)</label>
                {{ form.gallery_images }}
                <p class="text-xs text-gray-400 mt-1">می‌توانید چند عکس را همزمان انتخاب کنید.</p>

                {% if product and product.images.all %}
                <div class="flex flex-wrap gap-2 mt-4">
                    {% for img in product.images.all %}
                    <div class="relative group" id="img-{{ img.id }}">
                        <img src="{{ img.image.url }}" class="w-20 h-20 object-cover border rounded-lg">
                        <button type="button"
                                hx-post="{% url 'vendor_panel:delete_product_image' img.id %}"
                                hx-target="#img-{{ img.id }}"
                                hx-swap="delete"
                                hx-confirm="این عکس حذف شود؟"
                                class="absolute top-1 left-1 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition shadow-md">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>

        <div class="flex items-center gap-2 mt-4">
            {{ form.is_available }}
            <label class="text-sm text-gray-700">موجود برای فروش</label>
        </div>

        <div class="flex justify-end gap-3 pt-6 border-t mt-4">
            <a href="{% url 'vendor_panel:product_list' %}" class="px-6 py-2 rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200">انصراف</a>
            <button type="submit" class="px-6 py-2 rounded-lg bg-blue-600 text-white font-bold hover:bg-blue-700">ذخیره محصول</button>
        </div>
    </form>
</div>

<script>
    function productManager() {
        return {
            // بخش نام ساز
            category: '',
            brand: '',
            model: '{{ form.instance.model_name|default:"" }}',
            desc: '{{ form.instance.title_desc|default:"" }}',

            // بخش ویژگی‌ها
            specs: [],

            init() {
                // پر کردن نام‌ساز از مقادیر اولیه
                const catSelect = document.querySelector('#id_category');
                const brandSelect = document.querySelector('#id_brand');
                if(catSelect && catSelect.selectedIndex > -1) this.category = catSelect.options[catSelect.selectedIndex].text.replace(/-/g, '').trim();
                if(brandSelect && brandSelect.selectedIndex > -1) this.brand = brandSelect.options[brandSelect.selectedIndex].text.replace(/-/g, '').trim();

                // ✅ لود کردن ویژگی‌های موجود (از دیتابیس)
                // چون جنگو دیکشنری میده، ما تبدیل میکنیم به آرایه برای آلپاین
                const rawSpecs = {{ form.instance.specifications|default:"{}"|safe }};

                // تبدیل آبجکت { "Color": "Red" } به آرایه [ {key: "Color", value: "Red"} ]
                this.specs = Object.entries(rawSpecs).map(([key, value]) => ({ key, value }));

                // اگر خالی بود یک سطر خالی بذار
                if (this.specs.length === 0) {
                    this.specs.push({ key: '', value: '' });
                }
            },

            generateName() {
                let parts = [];
                let cleanCategory = this.category.replace(/[-]/g, '').trim();
                let cleanBrand = this.brand.replace(/[-]/g, '').trim();

                if (cleanCategory && cleanCategory !== '---------') parts.push(cleanCategory);
                if (cleanBrand && cleanBrand !== '---------') parts.push(cleanBrand);
                if (this.model) parts.push('مدل ' + this.model);
                if (this.desc) parts.push(this.desc);

                return parts.join(' ');
            },

            // متدهای ویژگی‌ها
            addSpec() {
                this.specs.push({ key: '', value: '' });
            },
            removeSpec(index) {
                this.specs.splice(index, 1);
            },

            // ✅ تبدیل آرایه آلپاین به JSON استاندارد برای ذخیره در دیتابیس
            get specJSON() {
                let obj = {};
                this.specs.forEach(item => {
                    if(item.key && item.value) {
                        obj[item.key] = item.value;
                    }
                });
                return JSON.stringify(obj);
            }
        }
    }
</script>